# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.box = "generic/centos7"
  config.vm.network "public_network", bridge: "Default Switch"
  config.vm.provider "hyperv" do |h|
    h.memory = 1024
    h.enable_virtualization_extensions = true
    h.differencing_disk = true
  end

  config.vm.define "grafana" do |node|
    node.vm.hostname = "grafana"
    config.vm.synced_folder ".", "/vagrant", type: "nfs", create: true
    #config.vm.provision :shell, :inline => "echo '#{id_rsa_ssh_key_pub }' >> /home/vagrant/.ssh/authorized_keys"
    node.vm.provision "shell", inline: <<-SHELL
      ls /
      df
      yum install epel-release collectd -y
      #chmod 600 /home/vagrant/.ssh/authorized_keys"
      if grep -Fxq "mykey" /home/vagrant/.ssh/authorized_keys
        then
          echo "Key already present"
        else
          ssh-keygen -C mykey -q -N "" -f /home/vagrant/id_rsa
          cp id_rsa /vagrant/id_rsa_grafana
          cat id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
        fi
    SHELL
  end
end